<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Consumo de Di√©sel</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; }
        h1, h2, h3 { color: #333; text-align: center; }
        .container { max-width: 900px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        form { display: flex; flex-direction: column; gap: 15px; }
        input, select, textarea, button { padding: 10px; border-radius: 4px; border: 1px solid #ddd; font-size: 16px; }
        button { cursor: pointer; }
        .loader { text-align: center; font-size: 1.2em; padding: 20px; }
        /* Estilos adicionales sin cambios... */
        #resumenTabla th { background-color: #28a745; }
        #resumenTabla tfoot tr, #resumenEmpresaTabla tfoot tr { font-weight: bold; background-color: #e9ecef; border-top: 2px solid #343a40; }
        @media print { .no-print { display: none !important; } /* ... */ }
    </style>
</head>
<body>
    <div class="container">
        <h1>Control de Di√©sel de Volquetas</h1>
        <div class="no-print" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
            <div><label for="filtroMes" style="font-weight: bold;">Filtrar por Mes:</label><select id="filtroMes"></select></div>
            <button id="btnPrint" style="background-color: #17a2b8; color: white; padding: 10px 20px; border: none;">üñ®Ô∏è Imprimir Reporte</button>
        </div>
    </div>
    <div class="container no-print" id="formularioContainer"> /* ... Formulario ... */ </div>
    <div class="container"><h2 id="loadingMessage" class="loader">Cargando datos...</h2></div>
    <div class="container"><h2>Totales por Volqueta</h2><table id="resumenTabla"><thead>...</thead><tbody id="resumenBody"></tbody><tfoot id="resumenFooter"></tfoot></table></div>
    <div class="container"><h2>Gastos por Empresa</h2><table id="resumenEmpresaTabla"><thead>...</thead><tbody id="resumenEmpresaBody"></tbody><tfoot id="resumenEmpresaFooter"></tfoot></table></div>
    <div class="container"><h2>Gr√°fico de Consumo por Volqueta</h2><canvas id="graficoConsumo" style="max-height: 400px;"></canvas></div>
    <div class="container"><h2>Historial de Consumos</h2><table id="historialTabla"><thead>...</thead><tbody id="historialBody"></tbody></table></div>
    <div class="container no-print" id="adminContainer"><h2>Administraci√≥n</h2> /* ... Contenido de Administraci√≥n ... */ </div>

    <script type="module">
        // --- INICIALIZACI√ìN DE FIREBASE Y VARIABLES GLOBALES ---
        // Estas funciones se importan del SDK de Firebase que pegaste arriba
        import { getFirestore, collection, getDocs, doc, addDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // La variable 'db' se debe inicializar en el script que pegaste de Firebase.
        // Si no lo hace, descomenta la siguiente l√≠nea y aseg√∫rate de que 'app' est√© definido.
        // const db = getFirestore(app);

        let miGrafico = null;
        let filtroMesActual = 'todos';
        let todosLosConsumos = []; // Cach√© local para no consultar Firebase constantemente
        let listasAdmin = { choferes: [], placas: [], empresas: [] };

        // --- MANEJADORES DE EVENTOS ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('fecha').valueAsDate = new Date();
            // Asignaci√≥n de todos los eventos
            document.getElementById('consumoForm').addEventListener('submit', guardarOActualizar);
            document.getElementById('btnPrint').addEventListener('click', () => window.print());
            document.getElementById('filtroMes').addEventListener('change', (e) => {
                filtroMesActual = e.target.value;
                actualizarTodaLaUI();
            });
            document.getElementById('historialBody').addEventListener('click', manejarAccionesHistorial);
            document.getElementById('adminContainer').addEventListener('click', manejarAccionesAdmin);
            document.getElementById('formAdminChofer').addEventListener('submit', (e) => { e.preventDefault(); agregarItemAdmin('choferes', document.getElementById('nuevoChofer')); });
            document.getElementById('formAdminPlaca').addEventListener('submit', (e) => { e.preventDefault(); agregarItemAdmin('placas', document.getElementById('nuevaPlaca')); });
            document.getElementById('formAdminEmpresa').addEventListener('submit', (e) => { e.preventDefault(); agregarItemAdmin('empresas', document.getElementById('nuevaEmpresa')); });
            
            cargarDatosIniciales();
        });

        // --- L√ìGICA PRINCIPAL ---
        async function cargarDatosIniciales() {
            document.getElementById('loadingMessage').style.display = 'block';
            try {
                // Cargar todas las listas y consumos en paralelo
                const [consumosRes, choferesRes, placasRes, empresasRes] = await Promise.all([
                    getDocs(query(collection(db, "consumos"), orderBy("fecha", "desc"))),
                    getDocs(query(collection(db, "choferes"), orderBy("nombre"))),
                    getDocs(query(collection(db, "placas"), orderBy("nombre"))),
                    getDocs(query(collection(db, "empresas"), orderBy("nombre")))
                ]);

                todosLosConsumos = consumosRes.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                listasAdmin.choferes = choferesRes.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                listasAdmin.placas = placasRes.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                listasAdmin.empresas = empresasRes.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                actualizarTodaLaUI();
            } catch (error) {
                console.error("Error cargando datos iniciales: ", error);
                alert("Error al cargar los datos. Revisa la consola (F12) para m√°s detalles y aseg√∫rate de haber pegado bien la configuraci√≥n de Firebase.");
            } finally {
                document.getElementById('loadingMessage').style.display = 'none';
            }
        }
        
        function actualizarTodaLaUI() {
            poblarFiltroDeMes();
            const consumosFiltrados = obtenerConsumosFiltrados();
            const datosResumenVolqueta = calcularYMostrarTotales(consumosFiltrados);
            calcularYMostrarTotalesPorEmpresa(consumosFiltrados);
            poblarSelectores();
            mostrarListasAdmin();
            mostrarHistorialAgrupado(consumosFiltrados);
            crearOActualizarGrafico(datosResumenVolqueta);
        }

        async function guardarOActualizar(e) {
            e.preventDefault();
            const id = document.getElementById('registroId').value;
            const datosConsumo = {
                volqueta: document.getElementById('selectVolqueta').value,
                fecha: document.getElementById('fecha').value,
                galones: document.getElementById('galones').value,
                costo: document.getElementById('costo').value,
                descripcion: document.getElementById('descripcion').value,
                chofer: document.getElementById('selectChofer').value,
                empresa: document.getElementById('selectEmpresa').value
            };

            try {
                if (id) { // Actualizar
                    const docRef = doc(db, "consumos", id);
                    await updateDoc(docRef, datosConsumo);
                } else { // Crear
                    await addDoc(collection(db, "consumos"), datosConsumo);
                }
                reiniciarFormulario();
                await cargarDatosIniciales(); // Recargar todo desde la base de datos
            } catch (error) {
                console.error("Error guardando el consumo: ", error);
                alert("No se pudo guardar el registro.");
            }
        }
        
        // --- L√ìGICA DE ADMINISTRACI√ìN ---
        async function agregarItemAdmin(tipo, inputElement) {
            const valor = (tipo === 'placas') ? inputElement.value.trim().toUpperCase() : inputElement.value.trim();
            if (valor) {
                const lista = listasAdmin[tipo].map(item => item.nombre.toUpperCase());
                if (lista.includes(valor.toUpperCase())) {
                    alert(`Este valor ya existe en la lista de ${tipo}.`);
                    return;
                }
                try {
                    await addDoc(collection(db, tipo), { nombre: valor });
                    inputElement.value = '';
                    await cargarDatosIniciales();
                } catch (error) {
                    console.error("Error agregando item: ", error);
                    alert("No se pudo agregar el item.");
                }
            }
        }

        async function modificarItemAdmin(tipo, item) {
            const valorActual = item.nombre;
            const nuevoValor = prompt(`Modificar valor para "${valorActual}":`, valorActual);
            
            if (!nuevoValor || nuevoValor.trim() === '' || nuevoValor.trim() === valorActual) return;
            const valorFormateado = (tipo === 'placas') ? nuevoValor.trim().toUpperCase() : nuevoValor.trim();
            
            if (confirm(`¬øEst√°s seguro de cambiar "${valorActual}" por "${valorFormateado}"? Esto NO actualizar√° los registros antiguos del historial.`)) {
                try {
                    const docRef = doc(db, tipo, item.id);
                    await updateDoc(docRef, { nombre: valorFormateado });
                    await cargarDatosIniciales();
                } catch(e) {
                    console.error("Error modificando item: ", e);
                    alert("No se pudo modificar el item.");
                }
            }
        }
        
        async function borrarItemAdmin(tipo, item) {
             if (confirm(`¬øSeguro que quieres borrar "${item.nombre}" de la lista de opciones?`)) {
                try {
                    await deleteDoc(doc(db, tipo, item.id));
                    await cargarDatosIniciales();
                } catch(e) {
                    console.error("Error borrando item: ", e);
                    alert("No se pudo borrar el item.");
                }
            }
        }
        
        async function borrarConsumoHistorial(id) {
            if (confirm('¬øSeguro que quieres borrar este registro del historial?')) {
                try {
                    await deleteDoc(doc(db, "consumos", id));
                    await cargarDatosIniciales();
                } catch (e) {
                    console.error("Error borrando consumo: ", e);
                    alert("No se pudo borrar el registro.");
                }
            }
        }
        
        // --- El resto de funciones ahora usan los datos en memoria ---
        // (Se asume que los datos ya est√°n cargados en las variables globales)
        
        function obtenerConsumosFiltrados() {
            if (filtroMesActual === 'todos') return todosLosConsumos;
            return todosLosConsumos.filter(c => c.fecha.startsWith(filtroMesActual));
        }

        function mostrarListasAdmin() {
            const contenedores = { choferes: 'listaChoferes', placas: 'listaPlacas', empresas: 'listaEmpresas' };
            for (const tipo in contenedores) {
                const ul = document.getElementById(contenedores[tipo]);
                ul.innerHTML = '';
                listasAdmin[tipo].forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${item.nombre}</span>
                        <div>
                            <button class="btn-accion btn-modificar">Modificar</button>
                            <button class="btn-accion btn-borrar">Borrar</button>
                        </div>`;
                    li.querySelector('.btn-modificar').addEventListener('click', () => modificarItemAdmin(tipo, item));
                    li.querySelector('.btn-borrar').addEventListener('click', () => borrarItemAdmin(tipo, item));
                    ul.appendChild(li);
                });
            }
        }
        
        // ... (el resto de funciones como calcularTotales, mostrarHistorial, poblarSelectores, etc. no cambian su l√≥gica interna, solo la fuente de sus datos)
        // Se incluyen aqu√≠ para que el c√≥digo est√© completo.
        function calcularYMostrarTotales(consumos) { const resumenBody = document.getElementById('resumenBody'); const resumenFooter = document.getElementById('resumenFooter'); const totales = {}; consumos.forEach(c => { if (!totales[c.volqueta]) totales[c.volqueta] = { totalGalones: 0, totalCosto: 0 }; totales[c.volqueta].totalGalones += parseFloat(c.galones); totales[c.volqueta].totalCosto += parseFloat(c.costo); }); const placasOrdenadas = Object.keys(totales).sort(); let htmlBody = ''; let granTotalGalones = 0; let granTotalCosto = 0; placasOrdenadas.forEach(placa => { const total = totales[placa]; htmlBody += `<tr><td><strong>${placa}</strong></td><td>${total.totalGalones.toFixed(2)}</td><td>$${total.totalCosto.toFixed(2)}</td></tr>`; granTotalGalones += total.totalGalones; granTotalCosto += total.totalCosto; }); resumenBody.innerHTML = htmlBody; resumenFooter.innerHTML = `<tr><td>TOTAL GENERAL</td><td>${granTotalGalones.toFixed(2)}</td><td>$${granTotalCosto.toFixed(2)}</td></tr>`; return { labels: placasOrdenadas, data: placasOrdenadas.map(placa => totales[placa].totalCosto) }; }
        function calcularYMostrarTotalesPorEmpresa(consumos) { const resumenBody = document.getElementById('resumenEmpresaBody'); const resumenFooter = document.getElementById('resumenEmpresaFooter'); const totales = {}; consumos.forEach(c => { if (!c.empresa) return; if (!totales[c.empresa]) totales[c.empresa] = { totalGalones: 0, totalCosto: 0 }; totales[c.empresa].totalGalones += parseFloat(c.galones); totales[c.empresa].totalCosto += parseFloat(c.costo); }); const empresasOrdenadas = Object.keys(totales).sort(); let htmlBody = ''; let granTotalGalones = 0; let granTotalCosto = 0; empresasOrdenadas.forEach(empresa => { const total = totales[empresa]; htmlBody += `<tr><td><strong>${empresa}</strong></td><td>${total.totalGalones.toFixed(2)}</td><td>$${total.totalCosto.toFixed(2)}</td></tr>`; granTotalGalones += total.totalGalones; granTotalCosto += total.totalCosto; }); resumenBody.innerHTML = htmlBody; resumenFooter.innerHTML = `<tr><td>TOTAL GENERAL</td><td>${granTotalGalones.toFixed(2)}</td><td>$${granTotalCosto.toFixed(2)}</td></tr>`; }
        function crearOActualizarGrafico(datos) { const ctx = document.getElementById('graficoConsumo').getContext('2d'); if (miGrafico) { miGrafico.destroy(); } miGrafico = new Chart(ctx, { type: 'bar', data: { labels: datos.labels, datasets: [{ label: 'Costo Total de Consumo ($)', data: datos.data, backgroundColor: 'rgba(40, 167, 69, 0.7)', borderColor: 'rgba(40, 167, 69, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: function(value) { return '$' + value.toFixed(2); } } } }, plugins: { legend: { display: true, position: 'top', } } } }); }
        function poblarSelectores() { const selectores = { choferes: document.getElementById('selectChofer'), placas: document.getElementById('selectVolqueta'), empresas: document.getElementById('selectEmpresa') }; const titulos = { choferes: '--- Seleccione un Chofer ---', placas: '--- Seleccione una Placa ---', empresas: '--- Seleccione una Empresa ---' }; for (const tipo in selectores) { const select = selectores[tipo]; if (!select) continue; const valorActual = select.value; select.innerHTML = `<option value="" disabled selected>${titulos[tipo]}</option>`; listasAdmin[tipo].forEach(item => select.innerHTML += `<option value="${item.nombre}">${item.nombre}</option>`); select.value = valorActual; } }
        function poblarFiltroDeMes() { const filtroSelect = document.getElementById('filtroMes'); const mesesUnicos = [...new Set(todosLosConsumos.map(c => c.fecha.substring(0, 7)))]; mesesUnicos.sort().reverse(); filtroSelect.innerHTML = '<option value="todos">Todos los Meses</option>'; mesesUnicos.forEach(mes => { const [year, month] = mes.split('-'); const fechaMes = new Date(year, month - 1); const nombreMes = fechaMes.toLocaleDateString('es-EC', { month: 'long', year: 'numeric' }); const opcion = document.createElement('option'); opcion.value = mes; opcion.textContent = nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1); filtroSelect.appendChild(opcion); }); filtroSelect.value = filtroMesActual; }
        function mostrarHistorialAgrupado(consumos) { const historialBody = document.getElementById('historialBody'); historialBody.innerHTML = ''; consumos.sort((a,b) => a.volqueta.localeCompare(b.volqueta) || new Date(b.fecha) - new Date(a.fecha)); let placaActual = ""; consumos.forEach(consumo => { if (consumo.volqueta !== placaActual) { placaActual = consumo.volqueta; historialBody.innerHTML += `<tr class="fila-grupo"><td colspan="9">Volqueta: ${placaActual}</td></tr>`; } const nombreMes = new Date(consumo.fecha + 'T00:00:00').toLocaleDateString('es-EC', { month: 'long' }); historialBody.innerHTML += `<tr><td>${consumo.fecha}</td><td>${nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1)}</td><td>${consumo.chofer}</td><td>${consumo.volqueta}</td><td>${parseFloat(consumo.galones).toFixed(2)}</td><td>$${parseFloat(consumo.costo).toFixed(2)}</td><td>${consumo.empresa || ''}</td><td>${consumo.descripcion}</td><td class="no-print"><button class="btn-accion btn-modificar" data-id="${consumo.id}">Modificar</button><button class="btn-accion btn-borrar" data-id="${consumo.id}">Borrar</button></td></tr>`; }); }
        function reiniciarFormulario() { document.getElementById('consumoForm').reset(); document.getElementById('registroId').value = ''; document.getElementById('fecha').valueAsDate = new Date(); document.getElementById('formularioTitulo').textContent = 'Nuevo Registro'; document.getElementById('btnGuardar').textContent = 'Guardar Registro'; poblarSelectores(); }
    </script>

</body>
</html>